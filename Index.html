<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Sholat Berjamaah | RS Islam Jakarta</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c786c',
                        secondary: '#004445',
                        accent: '#f8b400',
                        light: '#faf5e4',
                        dark: '#1a1a2e',
                        soft: '#e8f3f1',
                        success: '#38a169',
                        error: '#e53e3e'
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif']
                    },
                    spacing: {
                        '18': '4.5rem'
                    },
                    boxShadow: {
                        soft: '0 4px 20px rgba(44, 120, 108, 0.15)',
                        card: '0 10px 30px rgba(44, 120, 108, 0.2)'
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Hide number input arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Custom input focus */
        .input-focus:focus {
            border-color: #2c786c;
            box-shadow: 0 0 0 3px rgba(44, 120, 108, 0.2);
        }
        
        /* Kehadiran option */
        .kehadiran-option {
            transition: all 0.2s ease;
        }
        
        .kehadiran-option input:checked + label {
            background-color: rgba(44, 120, 108, 0.1);
            border-color: #2c786c;
            color: #2c786c;
        }
        
        /* Quote styling */
        .quote-container {
            background-color: #faf5e4;
            border-left: 4px solid #f8b400;
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        
        .quote-text {
            font-family: 'Playfair Display', serif;
            line-height: 1.6;
            font-size: 1rem;
            color: #004445;
        }
        
        .quote-author {
            font-style: italic;
            text-align: right;
            margin-top: 0.5rem;
            color: #2c786c;
            font-size: 0.875rem;
        }
        
        /* Style untuk tombol hapus */
        .btn-hapus {
            background-color: #f8f9fa;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-hapus:hover {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-hapus:disabled {
            opacity: 0.65;
            cursor: not-allowed;
            background-color: #f8f9fa;
            color: #dc3545;
        }

        /* Style tambahan untuk popup presensi */
        #popupPresensi h3 {
            line-height: 1.4;
        }

        #popupPresensi h3 span {
            display: inline-block;
            margin-top: 4px;
            color: #2c786c;
            font-size: 0.9rem;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #323232;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background-color: #e53e3e;
        }

        .toast.success {
            background-color: #38a169;
        }

        .toast i {
            margin-right: 8px;
        }
    </style>
</head>
<body class="font-sans bg-gray-50 text-gray-800 min-h-screen flex flex-col pt-20">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-gradient-to-r from-primary to-secondary text-white shadow-md z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col items-center">
                <h1 class="text-base font-bold flex items-center">
                    <i class="fas fa-mosque mr-2"></i>
                    <span>PRESENSI SHOLAT BERJAMAAH</span>
                </h1>
                <p class="text-xs mt-1 opacity-90">Rumah Sakit Islam Jakarta Sukapura</p>
            </div>
        </div>
    </header>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <i class="fas fa-info-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-4 py-6">
        <!-- Alert Box -->
        <div id="alertBox" class="hidden mb-6 rounded-lg px-4 py-3 text-sm" role="alert">
            <div class="flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                <span id="alertMessage"></span>
                <button type="button" class="ml-auto text-lg" onclick="hideAlert()">&times;</button>
            </div>
        </div>
        
        <!-- Form Card -->
        <div class="bg-white rounded-xl shadow-soft overflow-hidden border border-soft">
            <form id="presensiForm" class="p-6">
                <!-- Nomor Pegawai -->
                <div class="mb-6">
                    <label for="nopeg" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-id-card text-primary mr-3 w-5 text-center"></i>
                        Nomor Pegawai
                    </label>
                    <input type="number" id="nopeg" name="nopeg" required
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all input-focus"
                        placeholder="Masukkan nomor pegawai">
                    <div id="nopeg-error" class="hidden text-xs text-error mt-2"></div>
                </div>
                
                <!-- Nama Lengkap -->
                <div class="mb-6">
                    <label for="nama" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-user text-primary mr-3 w-5 text-center"></i>
                        Nama Lengkap
                    </label>
                    <input type="text" id="nama" name="nama" readonly
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                </div>
                
                <!-- Unit Kerja -->
                <div class="mb-6">
                    <label for="unit" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-building text-primary mr-3 w-5 text-center"></i>
                        Unit Kerja
                    </label>
                    <input type="text" id="unit" name="unit" readonly
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                </div>
                
                <!-- Profesi -->
                <div class="mb-6">
                    <label for="profesi" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-user-tag text-primary mr-3 w-5 text-center"></i>
                        Profesi
                    </label>
                    <input type="text" id="profesi" name="profesi" readonly
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                </div>
                
                <!-- Tanggal -->
                <div class="mb-6">
                    <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-calendar-alt text-primary mr-3 w-5 text-center"></i>
                        Tanggal
                    </label>
                    <input type="date" id="tanggal" name="tanggal" required
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all input-focus">
                </div>
                
                <!-- Waktu -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-clock text-primary mr-3 w-5 text-center"></i>
                        Waktu
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="time" id="jam" name="jam" required
                            class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all input-focus">
                        <div id="live-clock" class="flex items-center justify-center px-4 py-3 text-sm border border-gray-300 rounded-lg bg-gray-50 font-medium">
                            --:--:-- WIB
                        </div>
                    </div>
                </div>
                
                <!-- Waktu Sholat -->
                <div class="mb-6">
                    <label for="waktu" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-pray text-primary mr-3 w-5 text-center"></i>
                        Waktu Sholat
                    </label>
                    <select id="waktu" name="waktu" required disabled
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg bg-gray-50">
                        <option value="SHUBUH">SHUBUH</option>
                        <option value="DZUHUR">DZUHUR</option>
                        <option value="ASHAR">ASHAR</option>
                        <option value="MAGRIB">MAGRIB</option>
                        <option value="ISYA">ISYA</option>
                        <option value="BELUM MASUK WAKTU SHOLAT">BELUM MASUK WAKTU SHOLAT</option>
                    </select>
                </div>
                
                <!-- Kehadiran -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-user-check text-primary mr-3 w-5 text-center"></i>
                        Kehadiran
                    </label>
                    <div class="space-y-2">
                        <div class="kehadiran-option">
                            <input type="radio" id="hadir" name="kehadiran" value="HADIR" checked class="hidden">
                            <label for="hadir" class="flex items-center w-full px-4 py-3 text-sm border border-gray-300 rounded-lg cursor-pointer transition-all">
                                <i class="fas fa-check-circle text-primary mr-3"></i>
                                <span>Hadir di Masjid</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Bukti -->
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-camera text-primary mr-3 w-5 text-center"></i>
                        Bukti Kehadiran
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors"
                        id="upload-label">
                        <div class="flex flex-col items-center justify-center py-6">
                            <i class="fas fa-cloud-upload-alt text-3xl text-primary mb-3"></i>
                            <p class="text-sm text-gray-600 mb-1">Klik untuk upload foto (Opsional)</p>
                            <p class="text-xs text-gray-500">Format: JPG/PNG (Maks. 10MB)</p>
                        </div>
                        <input type="file" id="bukti-kehadiran" name="bukti_kehadiran" accept="image/*" class="hidden">
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" id="remove-image" class="btn-hapus hidden">
                            <i class="fas fa-trash-alt mr-1"></i> Hapus Gambar
                        </button>
                    </div>
                    <img id="image-preview" class="hidden w-full mt-3 rounded-lg border border-gray-200 max-h-48 object-contain">
                    <div id="image-error" class="hidden text-xs text-error mt-2"></div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" id="submitBtn"
                    class="w-full bg-primary hover:bg-secondary text-white font-medium py-3 px-4 rounded-lg shadow-md transition-all flex items-center justify-center">
                    <span id="submitText">Kirim Presensi</span>
                    <span id="submitSpinner" class="hidden ml-2">
                        <i class="fas fa-circle-notch fa-spin"></i>
                    </span>
                </button>
            </form>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-4">
        <div class="container mx-auto px-4 text-center">
            <p class="text-xs text-gray-500">&copy; 2025 RS Islam Jakarta Sukapura. All rights reserved.</p>
        </div>
    </footer>

    <!-- Success Popup with Quote -->
    <div id="popupPresensi" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-md w-full shadow-xl animate-fade-in">
            <div class="p-6">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                        <i class="fas fa-check text-green-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Presensi Tercatat</h3>
                    <p class="text-sm text-gray-500" id="thankYouMessage">
                        Quote Hari Ini
                    </p>
                    
                    <!-- Quote Section -->
                    <div id="quoteSection" class="quote-container">
                        <p id="quoteText" class="quote-text">Quote Hari Ini</p>
                        <p id="quoteAuthor" class="quote-author"></p>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button type="button" id="closePopup" disabled
                        class="inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-primary text-sm font-medium text-white hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all disabled:opacity-70 disabled:cursor-not-allowed">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Popup -->
    <div id="popupRegistration" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-md w-full shadow-xl animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-user-plus text-primary mr-2"></i>
                        Registrasi Pegawai Baru
                    </h3>
                    <button type="button" id="cancelRegistration" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="regNopeg" class="block text-sm font-medium text-gray-700 mb-1">Nomor Pegawai</label>
                        <input type="number" id="regNopeg" name="regNopeg" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary input-focus">
                        <div id="regNopeg-error" class="hidden text-xs text-error mt-1"></div>
                    </div>
                    
                    <div>
                        <label for="regNama" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                        <input type="text" id="regNama" name="regNama" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary input-focus">
                    </div>
                    
                    <div>
                        <label for="regUnit" class="block text-sm font-medium text-gray-700 mb-1">Unit Kerja</label>
                        <input type="text" id="regUnit" name="regUnit" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary input-focus">
                    </div>
                    
                    <div>
                        <label for="regProfesi" class="block text-sm font-medium text-gray-700 mb-1">Profesi</label>
                        <select id="regProfesi" name="regProfesi" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary input-focus">
                            <option value="">Pilih Profesi</option>
                            <option value="MEDIS">Medis</option>
                            <option value="NON MEDIS">Non Medis</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="regJk" class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                        <select id="regJk" name="regJk" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-primary focus:border-primary input-focus">
                            <option value="">Pilih Jenis Kelamin</option>
                            <option value="LAKI-LAKI">Laki-laki</option>
                            <option value="PEREMPUAN">Perempuan</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancelRegistrationBtn"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Batal
                    </button>
                    <button type="button" id="submitRegistration"
                        class="px-4 py-2 text-sm font-medium text-white bg-primary border border-transparent rounded-md shadow-sm hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary inline-flex items-center">
                        <span id="regSubmitText">Daftar</span>
                        <span id="regSubmitSpinner" class="hidden ml-2">
                            <i class="fas fa-circle-notch fa-spin"></i>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Data pegawai contoh untuk mode demo
        const demoPegawai = {
            '12345': {
                nama: 'Nama Contoh Pegawai',
                unit: 'Unit Kerja Contoh',
                profesi: 'MEDIS'
            },
            '67890': {
                nama: 'Pegawai Contoh Lain',
                unit: 'Unit Lain',
                profesi: 'NON MEDIS'
            }
        };

        // Data presensi yang disimpan (untuk mode demo)
        let presensiData = [];

        // Fungsi untuk menampilkan toast notification
        function showToast(message, type = 'info', duration = 5000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            toast.classList.add('show');
            
            // Auto hide setelah duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, duration);
        }

        // Fungsi untuk memformat tanggal
        function formatTanggal(dateString) {
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jum\'at', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const date = new Date(dateString);
            const dayName = days[date.getDay()];
            const dateNum = date.getDate();
            const monthName = months[date.getMonth()];
            const year = date.getFullYear();
            
            return `${dayName}, ${dateNum} ${monthName} ${year}`;
        }

        // Fungsi untuk kompres gambar (optimized)
        async function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Fungsi untuk menampilkan alert
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            const alertMessage = document.getElementById('alertMessage');
            
            alertBox.className = `mb-6 rounded-lg px-4 py-3 text-sm flex items-center bg-${type}-100 text-${type}-700`;
            alertMessage.textContent = message;
            alertBox.classList.remove('hidden');
            
            // Auto hide setelah 5 detik
            setTimeout(hideAlert, 5000);
        }

        // Fungsi untuk menyembunyikan alert
        function hideAlert() {
            document.getElementById('alertBox').classList.add('hidden');
        }

        // Fungsi untuk mengatur waktu saat ini
        function setCurrentDateTime() {
            const today = new Date();
            const timezoneOffset = today.getTimezoneOffset() * 60000;
            const localDate = new Date(today.getTime() - timezoneOffset);
            
            document.getElementById('tanggal').value = localDate.toISOString().split('T')[0];
            
            const hours = String(today.getHours()).padStart(2, '0');
            const minutes = String(today.getMinutes()).padStart(2, '0');
            document.getElementById('jam').value = `${hours}:${minutes}`;
            
            detectPrayerTime(hours, minutes);
            
            return { hours, minutes };
        }

        // Fungsi untuk update jam live
        function startLiveClock() {
            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                document.getElementById('live-clock').textContent = `${hours}:${minutes}:${seconds} WIB`;
                
                if (now.getSeconds() === 0 && document.activeElement !== document.getElementById('jam')) {
                    document.getElementById('jam').value = `${hours}:${minutes}`;
                    detectPrayerTime(hours, minutes);
                }
            }
            
            updateClock();
            setInterval(updateClock, 1000);
        }

        // Fungsi untuk mendeteksi waktu sholat (optimized)
        function detectPrayerTime(hours, minutes) {
            const hour = parseInt(hours);
            const minute = parseInt(minutes);
            const today = new Date();
            const isFriday = today.getDay() === 5;
            const isDhuhrTime = hour >= 12 && hour < 15;
            
            let currentPrayer = "BELUM MASUK WAKTU SHOLAT";
            const waktuSelect = document.getElementById('waktu');
            
            // Clear existing options
            waktuSelect.innerHTML = '';
            
            if (isFriday && isDhuhrTime) {
                // Jumat waktu Dzuhur
                const prayers = ["JUM'AT", "DZUHUR"];
                prayers.forEach(prayer => {
                    const option = document.createElement('option');
                    option.value = prayer;
                    option.textContent = prayer;
                    waktuSelect.appendChild(option);
                });
                currentPrayer = "JUM'AT";
            } else {
                // Hari biasa atau Jumat di luar waktu Dzuhur
                const prayers = [
                    {value: "SHUBUH", text: "SHUBUH", condition: hour >= 4 && hour < 6},
                    {value: "DZUHUR", text: "DZUHUR", condition: hour >= 12 && hour < 15},
                    {value: "ASHAR", text: "ASHAR", condition: (hour === 15 && minute >= 0) || (hour > 15 && hour < 18)},
                    {value: "MAGRIB", text: "MAGRIB", condition: hour >= 18 && hour < 19},
                    {value: "ISYA", text: "ISYA", condition: hour >= 19 || hour < 4},
                    {value: "BELUM MASUK WAKTU SHOLAT", text: "BELUM MASUK WAKTU SHOLAT", condition: true}
                ];
                
                prayers.forEach(prayer => {
                    const option = document.createElement('option');
                    option.value = prayer.value;
                    option.textContent = prayer.text;
                    waktuSelect.appendChild(option);
                    
                    if (prayer.condition && currentPrayer === "BELUM MASUK WAKTU SHOLAT") {
                        currentPrayer = prayer.value;
                    }
                });
            }
            
            waktuSelect.value = currentPrayer;
            waktuSelect.disabled = !(isFriday && isDhuhrTime);
        }

        // Fungsi untuk menangani upload gambar (optimized)
        function setupImageUpload() {
            const uploadInput = document.getElementById('bukti-kehadiran');
            const uploadLabel = document.getElementById('upload-label');
            const imagePreview = document.getElementById('image-preview');
            const removeImage = document.getElementById('remove-image');
            const imageError = document.getElementById('image-error');
            
            removeImage.disabled = false;

            uploadLabel.addEventListener('click', () => uploadInput.click());
            
            uploadInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validasi ukuran file
                if (file.size > 10 * 1024 * 1024) {
                    showToast('Ukuran file terlalu besar. Maksimal 10MB.', 'error');
                    imageError.textContent = 'Ukuran file terlalu besar (maks. 10MB)';
                    imageError.classList.remove('hidden');
                    uploadInput.value = '';
                    return;
                }
                
                // Validasi tipe file
                if (!file.type.match('image.*')) {
                    showToast('Hanya file gambar yang diizinkan.', 'error');
                    imageError.textContent = 'Hanya file gambar yang diizinkan';
                    imageError.classList.remove('hidden');
                    uploadInput.value = '';
                    return;
                }
                
                imageError.classList.add('hidden');
                
                try {
                    const compressedBlob = await compressImage(file);
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        imagePreview.src = event.target.result;
                        imagePreview.classList.remove('hidden');
                        uploadLabel.classList.add('hidden');
                        removeImage.classList.remove('hidden');
                    };
                    
                    reader.onerror = function() {
                        showToast('Gagal membaca file gambar', 'error');
                        imageError.classList.remove('hidden');
                        imageError.textContent = 'Gagal membaca file gambar';
                    };
                    
                    reader.readAsDataURL(compressedBlob);
                } catch (error) {
                    showToast('Gagal memproses gambar', 'error');
                    imageError.classList.remove('hidden');
                    imageError.textContent = 'Gagal memproses gambar';
                    uploadInput.value = '';
                }
            });
            
            removeImage.addEventListener('click', function() {
                uploadInput.value = '';
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
                uploadLabel.classList.remove('hidden');
                removeImage.classList.add('hidden');
                imageError.classList.add('hidden');
            });
        }

        // Fungsi untuk menampilkan quote dalam popup sukses (optimized)
        function showQuoteInPopup() {
            try {
                const userName = document.getElementById('nama').value || 'sahabat';
                const waktuSholat = document.getElementById('waktu').value;
                const tanggalPresensi = document.getElementById('tanggal').value;
                const formattedDate = formatTanggal(tanggalPresensi);
                
                document.getElementById('thankYouMessage').innerHTML = 
                    `Alhamdulillah, terima kasih<br>
                     <strong>${userName}</strong><br>
                    telah melakukan presensi sholat ${waktuSholat} berjamaah.`;
                
                const presensiTercatatElement = document.querySelector('#popupPresensi h3');
                presensiTercatatElement.innerHTML = `Presensi Tercatat<br>
                    <span class="text-sm font-normal">${formattedDate}</span>`;
                
                // Quote acak untuk demo
                const quotes = [
                    {
                        text: "Sholat berjamaah memiliki 27 kali lipat keutamaan dibanding sholat sendirian",
                        author: "HR. Bukhari Muslim"
                    },
                    {
                        text: "Barangsiapa yang sholat berjamaah, maka Allah akan cukupkan segala kebutuhannya",
                        author: "HR. Ibnu Majah"
                    },
                    {
                        text: "Kebersamaan dalam sholat menguatkan ikatan persaudaraan",
                        author: "HR. Muslim"
                    },
                    {
                        text: "Sholat adalah tiang agama, barangsiapa mendirikannya maka ia telah mendirikan agama",
                        author: "HR. Baihaqi"
                    }
                ];
                
                const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                document.getElementById('quoteText').textContent = randomQuote.text;
                document.getElementById('quoteAuthor').textContent = `- ${randomQuote.author}`;
                document.getElementById('closePopup').disabled = false;
                
            } catch (error) {
                document.getElementById('quoteText').textContent = 
                    "Barangsiapa yang sholat berjamaah, maka Allah akan cukupkan segala kebutuhannya";
                document.getElementById('quoteAuthor').textContent = "- HR. Ibnu Majah";
                document.getElementById('closePopup').disabled = false;
            }
        }

        // Fungsi untuk menonaktifkan TAB di handphone
        function disableMobileTab() {
            if (window.innerWidth <= 768) {
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') e.preventDefault();
                });
                
                document.getElementById('presensiForm').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') e.preventDefault();
                });
            }
        }

        // Fungsi untuk auto-fill data pegawai (optimized)
        function setupAutoFill() {
            const nopegInput = document.getElementById('nopeg');
            const errorElement = document.getElementById('nopeg-error');
            
            nopegInput.addEventListener('blur', function() {
                const nopeg = this.value.trim();
                
                if (!nopeg) {
                    clearEmployeeFields();
                    errorElement.textContent = 'Nomor pegawai tidak boleh kosong';
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                if (!/^\d+$/.test(nopeg)) {
                    clearEmployeeFields();
                    errorElement.textContent = 'Nomor pegawai harus berupa angka';
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                // Cek data pegawai dari demo data
                if (demoPegawai[nopeg]) {
                    document.getElementById('nama').value = demoPegawai[nopeg].nama;
                    document.getElementById('unit').value = demoPegawai[nopeg].unit;
                    document.getElementById('profesi').value = demoPegawai[nopeg].profesi;
                    errorElement.classList.add('hidden');
                } else {
                    clearEmployeeFields();
                    errorElement.textContent = 'Nomor pegawai tidak ditemukan';
                    errorElement.classList.remove('hidden');
                    showRegistrationPopup(nopeg);
                }
            });
            
            function clearEmployeeFields() {
                document.getElementById('nama').value = '';
                document.getElementById('unit').value = '';
                document.getElementById('profesi').value = '';
            }
            
            function showRegistrationPopup(nopeg) {
                document.getElementById('popupRegistration').classList.remove('hidden');
                document.getElementById('regNopeg').value = nopeg;
                document.getElementById('regNopeg').readOnly = true;
            }
        }

        // Fungsi untuk reset form
        function resetForm() {
            document.getElementById('presensiForm').reset();
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('upload-label').classList.remove('hidden');
            document.getElementById('remove-image').classList.add('hidden');
            document.getElementById('bukti-kehadiran').value = '';
            document.getElementById('remove-image').disabled = false;
            setCurrentDateTime();
            document.getElementById('nopeg').focus();
        }

        // Fungsi untuk setup form submission (optimized)
        function setupFormSubmission() {
            const form = document.getElementById('presensiForm');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            const removeImageBtn = document.getElementById('remove-image');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validasi waktu sholat
                const waktuSholat = document.getElementById('waktu').value;
                if (waktuSholat === "BELUM MASUK WAKTU SHOLAT") {
                    showToast('Belum masuk waktu sholat. Presensi tidak dapat dilakukan.', 'error');
                    return;
                }
                
                // Nonaktifkan tombol hapus saat submit
                if (removeImageBtn && !removeImageBtn.classList.contains('hidden')) {
                    removeImageBtn.disabled = true;
                }
                
                const nopeg = document.getElementById('nopeg').value.trim();
                if (!nopeg) {
                    showToast('Nomor pegawai tidak boleh kosong', 'error');
                    document.getElementById('nopeg').focus();
                    return;
                }
                
                if (!/^\d+$/.test(nopeg)) {
                    showToast('Nomor pegawai harus berupa angka', 'error');
                    document.getElementById('nopeg').focus();
                    return;
                }
                
                // Tampilkan loading state
                submitBtn.disabled = true;
                submitText.textContent = 'Mengirim...';
                submitSpinner.classList.remove('hidden');
                
                // Siapkan data form
                const formData = {
                    nopeg: nopeg,
                    nama: document.getElementById('nama').value,
                    unit: document.getElementById('unit').value,
                    profesi: document.getElementById('profesi').value,
                    tanggal: document.getElementById('tanggal').value,
                    jam: document.getElementById('jam').value,
                    waktu: waktuSholat,
                    kehadiran: document.querySelector('input[name="kehadiran"]:checked').value,
                    bukti_kehadiran: null
                };
                
                // Handle image upload jika ada
                const uploadInput = document.getElementById('bukti-kehadiran');
                if (uploadInput.files && uploadInput.files.length > 0) {
                    try {
                        const compressedBlob = await compressImage(uploadInput.files[0]);
                        const reader = new FileReader();
                        
                        reader.onload = function(event) {
                            formData.bukti_kehadiran = event.target.result.split(',')[1];
                            sendFormData(formData);
                        };
                        
                        reader.onerror = function() {
                            resetSubmitButton();
                            showToast('Gagal membaca file gambar', 'error');
                        };
                        
                        reader.readAsDataURL(compressedBlob);
                    } catch (error) {
                        resetSubmitButton();
                        showToast('Gagal memproses gambar', 'error');
                    }
                } else {
                    sendFormData(formData);
                }
            });
            
            function resetSubmitButton() {
                submitBtn.disabled = false;
                submitText.textContent = 'Kirim Presensi';
                submitSpinner.classList.add('hidden');
                const removeImageBtn = document.getElementById('remove-image');
                if (removeImageBtn) removeImageBtn.disabled = false;
            }
            
            function sendFormData(formData) {
                // Simpan data presensi untuk demo
                presensiData.push(formData);
                console.log('Data presensi disimpan:', formData);
                
                // Tampilkan popup sukses
                setTimeout(() => {
                    resetSubmitButton();
                    document.getElementById('popupPresensi').classList.remove('hidden');
                    document.getElementById('closePopup').disabled = true;
                    showQuoteInPopup();
                }, 1000);
            }
        }

        // Fungsi untuk setup registration popup (optimized)
        function setupRegistration() {
            const submitBtn = document.getElementById('submitRegistration');
            const cancelBtn = document.getElementById('cancelRegistration');
            const cancelBtn2 = document.getElementById('cancelRegistrationBtn');
            const regNopeg = document.getElementById('regNopeg');
            const regNama = document.getElementById('regNama');
            const regUnit = document.getElementById('regUnit');
            const regProfesi = document.getElementById('regProfesi');
            const regJk = document.getElementById('regJk');
            const regNopegError = document.getElementById('regNopeg-error');
            const regSubmitText = document.getElementById('regSubmitText');
            const regSubmitSpinner = document.getElementById('regSubmitSpinner');
            
            function closePopup() {
                document.getElementById('popupRegistration').classList.add('hidden');
                regNopeg.value = '';
                regNama.value = '';
                regUnit.value = '';
                regProfesi.value = '';
                regJk.value = '';
                regNopeg.readOnly = false;
                regNopegError.classList.add('hidden');
                document.getElementById('nopeg').focus();
            }
            
            cancelBtn.addEventListener('click', closePopup);
            cancelBtn2.addEventListener('click', closePopup);
            
            submitBtn.addEventListener('click', function() {
                // Validasi form
                if (!regNopeg.value.trim()) {
                    regNopegError.textContent = 'Nomor pegawai tidak boleh kosong';
                    regNopegError.classList.remove('hidden');
                    regNopeg.focus();
                    return;
                }
                
                if (!/^\d+$/.test(regNopeg.value.trim())) {
                    regNopegError.textContent = 'Nomor pegawai harus berupa angka';
                    regNopegError.classList.remove('hidden');
                    regNopeg.focus();
                    return;
                }
                
                if (!regNama.value.trim()) {
                    showToast('Nama lengkap harus diisi', 'error');
                    regNama.focus();
                    return;
                }
                
                if (!regUnit.value.trim()) {
                    showToast('Unit kerja harus diisi', 'error');
                    regUnit.focus();
                    return;
                }
                
                if (!regProfesi.value) {
                    showToast('Profesi harus dipilih', 'error');
                    regProfesi.focus();
                    return;
                }
                
                if (!regJk.value) {
                    showToast('Jenis kelamin harus dipilih', 'error');
                    regJk.focus();
                    return;
                }
                
                regNopegError.classList.add('hidden');
                
                // Tampilkan loading state
                submitBtn.disabled = true;
                regSubmitText.textContent = 'Mendaftarkan...';
                regSubmitSpinner.classList.remove('hidden');
                
                // Simpan data pegawai baru untuk demo
                setTimeout(() => {
                    const newPegawai = {
                        nopeg: regNopeg.value.trim(),
                        nama: regNama.value.trim(),
                        unit: regUnit.value.trim(),
                        profesi: regProfesi.value,
                        jk: regJk.value
                    };
                    
                    // Tambahkan ke data demo
                    demoPegawai[newPegawai.nopeg] = {
                        nama: newPegawai.nama,
                        unit: newPegawai.unit,
                        profesi: newPegawai.profesi
                    };
                    
                    // Reset form dan tampilkan pesan sukses
                    submitBtn.disabled = false;
                    regSubmitText.textContent = 'Daftar';
                    regSubmitSpinner.classList.add('hidden');
                    
                    closePopup();
                    document.getElementById('nopeg').value = newPegawai.nopeg;
                    document.getElementById('nama').value = newPegawai.nama;
                    document.getElementById('unit').value = newPegawai.unit;
                    document.getElementById('profesi').value = newPegawai.profesi;
                    showToast('Pendaftaran berhasil! Data telah diisi otomatis.', 'success');
                }, 1000);
            });
        }

        // Inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Tampilkan warning mode demo
                showToast('Aplikasi berjalan dalam mode demo (tanpa backend)', 'error', 10000);
                
                const { hours, minutes } = setCurrentDateTime();
                detectPrayerTime(hours, minutes);
                startLiveClock();
                setupImageUpload();
                disableMobileTab();
                setupAutoFill();
                setupFormSubmission();
                setupRegistration();
                
                document.getElementById('closePopup').addEventListener('click', function() {
                    document.getElementById('popupPresensi').classList.add('hidden');
                    resetForm();
                });
                
                document.getElementById('jam').addEventListener('change', function() {
                    const [hours, minutes] = this.value.split(':');
                    detectPrayerTime(hours, minutes);
                });
                
                document.getElementById('tanggal').addEventListener('change', function() {
                    const selectedDate = new Date(this.value);
                    const now = new Date();
                    const currentHours = now.getHours();
                    const currentMinutes = now.getMinutes();
                    detectPrayerTime(currentHours, currentMinutes);
                });
                
                document.getElementById('nopeg').focus();
            } catch (error) {
                showToast('Gagal menginisialisasi aplikasi', 'error');
            }
        });
    </script>
</body>
</html>